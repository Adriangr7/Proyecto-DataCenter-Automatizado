---
# tasks/overlay/evpn_bgp.yml
# NO crea BGP, solo aÃ±ade EVPN encima del BGP underlay existente

- name: Obtener VLANs desde NetBox
  uri:
    url: "{{ netbox_url }}/api/ipam/vlans/"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    return_content: yes
  register: vlans_raw
  delegate_to: localhost

##################################################
# SPINE: solo aseguramos address-family evpn
##################################################
- name: Asegurar address-family EVPN en spine
  eos_config:
    parents:
      - "router bgp {{ spine_asn }}"
      - "address-family evpn"
    lines: []
  when: inventory_hostname in groups['spines']

##################################################
# LEAFS: EVPN + VLAN submode
##################################################
- name: Calcular ASN del leaf
  set_fact:
    leaf_asn: "{{ leaf_asn_base + (inventory_hostname | regex_replace('Leaf_Router_', '') | int) }}"
  when: inventory_hostname in groups['leafs']

- name: Activar address-family EVPN en leafs
  eos_config:
    parents:
      - "router bgp {{ leaf_asn }}"
      - "address-family evpn"
    lines:
      - "advertise-all-vni"
  when: inventory_hostname in groups['leafs']

- name: Configurar EVPN por VLAN en leafs
  eos_config:
    parents: "router bgp {{ leaf_asn }}"
    lines: >-
      {{
        [
          "vlan " ~ (item.vid | string),
          "   rd {{ leaf_asn }}:" ~ (item.vid | string),
          "   route-target both {{ evpn_rt_base }}:" ~ (item.vid | string),
          "   redistribute learned"
        ]
      }}
  loop: "{{ vlans_raw.json.results }}"
  when: inventory_hostname in groups['leafs']

