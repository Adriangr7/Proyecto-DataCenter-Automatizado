###############################################
# 1. Obtener IP de Loopback0 desde NetBox
###############################################
- name: Obtener IP de Loopback0 desde NetBox
  uri:
    url: "{{ netbox_url }}/api/ipam/ip-addresses/?assigned_object_type=dcim.interface&assigned_object_id={{ hostvars['localhost'][inventory_hostname + '_loopback_if_id'] }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    return_content: yes
  register: loopback_ip_raw

###############################################
# 2. Extraer la IP /32
###############################################
- name: Guardar IP de Loopback0
  set_fact:
    loopback_ip: "{{ loopback_ip_raw.json.results[0].address }}"

- debug:
    msg: "Loopback0 de {{ inventory_hostname }} tiene la IP {{ loopback_ip }}"

###############################################
# 3. Aplicar configuraci√≥n EOS
###############################################
- name: Configurar Loopback0 en EOS
  eos_config:
    parents: "interface Loopback0"
    lines:
      - "ip address {{ loopback_ip }}"
  become: yes
  become_method: enable
