###############################################
# BGP UNDERLAY + EVPN (DISEÃ‘O MODERNO)
###############################################

###############################################
# 1. Obtener Loopback0 del dispositivo actual
###############################################
- name: Obtener ID de Loopback0
  uri:
    url: "{{ netbox_url }}/api/dcim/interfaces/?device={{ inventory_hostname }}&name=Loopback0"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    return_content: yes
  register: loopback_if
  delegate_to: localhost

- name: Obtener IP de Loopback0
  uri:
    url: "{{ netbox_url }}/api/ipam/ip-addresses/?assigned_object_id={{ loopback_if.json.results[0].id }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    return_content: yes
  register: loopback_ip_raw
  delegate_to: localhost

- name: Guardar IP de Loopback0
  set_fact:
    loopback_ip: "{{ loopback_ip_raw.json.results[0].address.split('/')[0] }}"

###############################################
# 2. Obtener ASN real desde NetBox (solo leafs)
###############################################
- name: Obtener ASN desde NetBox
  uri:
    url: "{{ netbox_url }}/api/dcim/devices/?name={{ inventory_hostname }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    return_content: yes
  register: device_info
  delegate_to: localhost
  when: inventory_hostname in groups['leafs']

- name: Guardar ASN del leaf
  set_fact:
    leaf_asn: "{{ device_info.json.results[0].custom_fields.asn }}"
  when: inventory_hostname in groups['leafs']

###############################################
# 3. Inicializar vecinos underlay
###############################################
- name: Inicializar lista de vecinos underlay
  set_fact:
    underlay_neighbors: []

###############################################
# 4. Construir vecinos underlay
###############################################
- name: Construir vecinos underlay
  include_tasks: build_neighbor.yml
  loop: "{{ links }}"
  loop_control:
    loop_var: this_link
  when: inventory_hostname in [this_link.spine, this_link.leaf]

###############################################
# 5. BGP UNDERLAY EN SPINES
###############################################
- name: BGP base en spines
  eos_config:
    parents: "router bgp {{ spine_asn }}"
    lines:
      - "router-id {{ loopback_ip }}"
      - "no bgp default ipv4-unicast"
  when: inventory_hostname in groups['spines']

- name: Vecinos underlay en spines
  eos_config:
    parents: "router bgp {{ spine_asn }}"
    lines:
      - "neighbor {{ item.ip }} remote-as {{ item.asn }}"
  loop: "{{ underlay_neighbors }}"
  when: inventory_hostname in groups['spines']

- name: Activar IPv4 en spines
  eos_config:
    parents:
      - "router bgp {{ spine_asn }}"
      - "address-family ipv4"
    lines:
      - "neighbor {{ item.ip }} activate"
  loop: "{{ underlay_neighbors }}"
  when: inventory_hostname in groups['spines']

- name: Anunciar loopback en spines
  eos_config:
    parents:
      - "router bgp {{ spine_asn }}"
      - "address-family ipv4"
    lines:
      - "network {{ loopback_ip }}/32"
  when: inventory_hostname in groups['spines']

###############################################
# 6. BGP UNDERLAY EN LEAFS
###############################################
- name: BGP base en leafs
  eos_config:
    parents: "router bgp {{ leaf_asn }}"
    lines:
      - "router-id {{ loopback_ip }}"
      - "no bgp default ipv4-unicast"
  when: inventory_hostname in groups['leafs']

- name: Vecinos underlay en leafs
  eos_config:
    parents: "router bgp {{ leaf_asn }}"
    lines:
      - "neighbor {{ item.ip }} remote-as {{ item.asn }}"
  loop: "{{ underlay_neighbors }}"
  when: inventory_hostname in groups['leafs']

- name: Activar IPv4 en leafs
  eos_config:
    parents:
      - "router bgp {{ leaf_asn }}"
      - "address-family ipv4"
    lines:
      - "neighbor {{ item.ip }} activate"
  loop: "{{ underlay_neighbors }}"
  when: inventory_hostname in groups['leafs']

- name: Anunciar loopback en leafs
  eos_config:
    parents:
      - "router bgp {{ leaf_asn }}"
      - "address-family ipv4"
    lines:
      - "network {{ loopback_ip }}/32"
  when: inventory_hostname in groups['leafs']

###############################################
# 7. EVPN: obtener VLANs desde NetBox
###############################################
- name: Obtener VLANs desde NetBox
  uri:
    url: "{{ netbox_url }}/api/ipam/vlans/"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    return_content: yes
  register: vlans_raw
  delegate_to: localhost
  when: inventory_hostname in groups['leafs']

###############################################
# 8. EVPN EN LEAFS
###############################################
- name: Activar EVPN en leafs
  eos_config:
    parents:
      - "router bgp {{ leaf_asn }}"
      - "address-family evpn"
    lines: []
  when: inventory_hostname in groups['leafs']

- name: Activar EVPN en vecinos underlay (leafs)
  eos_config:
    parents:
      - "router bgp {{ leaf_asn }}"
      - "address-family evpn"
    lines:
      - "neighbor {{ item.ip }} activate"
  loop: "{{ underlay_neighbors }}"
  when: inventory_hostname in groups['leafs']

- name: Configurar EVPN por VLAN
  eos_config:
    parents:
      - "router bgp {{ leaf_asn }}"
      - "vlan {{ item.vid }}"
    lines:
      - "rd {{ leaf_asn }}:{{ item.vid }}"
      - "route-target both {{ evpn_rt_base }}:{{ item.vid }}"
      - "redistribute learned"
  loop: "{{ vlans_raw.json.results }}"
  when: inventory_hostname in groups['leafs']

###############################################
# 9. EVPN EN SPINE (sobre underlay)
###############################################
- name: Activar EVPN en vecinos del spine
  eos_config:
    parents:
      - "router bgp {{ spine_asn }}"
      - "address-family evpn"
    lines:
      - "neighbor {{ item.ip }} activate"
  loop: "{{ underlay_neighbors }}"
  when: inventory_hostname in groups['spines']

